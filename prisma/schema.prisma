// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id String @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? //  If this has a date, the org is "soft deleted"
  name String 
  stripeCustomerId String?

  memberships Membership[]
  invitations Invitation[]
  credentials Credential[]
  stripeCustomer StripeCustomer?

  projects Project[]
  auditLogs AuditLog[]

}

model StripeCustomer {
  organizationId     String             @unique
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerId         String             @unique

  subscriptionId     String?
  subscriptionStatus StripeSubscriptionStatus?
  productId          String?
  priceId            String?
  eventAt            Int?
}

enum StripeSubscriptionStatus {
  active
  incomplete
  incomplete_expired
  past_due
  canceled
  unpaid
  trialing
  paused
}

model Credential {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  secretHash     String       @unique
  name           String
  lastUsed       DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  @@index([organizationId])
}

model Invitation {
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  email String
  tokenHash String @unique
  organizationId String
  organization Organization @relation(fields: [organizationId] ,references: [id], onDelete: Cascade )
  invitedByUserId String?
  invitedByUser User? @relation(fields: [invitedByUserId], references: [id], onDelete: SetNull)
  status InvitationStatus @default(PENDING)

  @@id(name: "invitationId", [organizationId, email])
  @@index([organizationId])
}

enum InvitationStatus {
  PENDING
  ACCEPTED_WITHOUT_ACCOUNT
}


model Membership {
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  joinedAt DateTime @default(now())
  isActive Boolean
  membershipRole MembershipRole @default(MEMBER)

  //permissions
  canDeleteProject Boolean @default(false)
  canEditProject      Boolean @default(false)

  canDeleteInspection Boolean @default(false)
  canEditInspection   Boolean @default(false)

  canDeleteDefect Boolean @default(false)
  canEditDefect   Boolean @default(false)

  @@id(name: "MembershipId", [organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

enum MembershipRole {
  ADMIN
  MEMBER
}

model User {
  id              String        @id @default(cuid())
  username        String            @unique
  email           String            @unique
  emailVerified   Boolean           @default(false)
  passwordHash    String

    // --- ADD THESE FIELDS ---
  firstName       String?
  lastName        String?
  role            String?        
  //image           String?         
  // ------------------------

  sessions Session[]
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  memberships Membership[]
  comments Comment[]
  invitesByUsers Invitation[]
  
  conductedInspections    Inspection[]            @relation("ConductedByUser")

  projects Project[]
  auditLogs AuditLog[]
  
}

model AuditLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  action      String   // e.g. "INSPECTION_APPROVED", "PROJECT_DELETED"
  entityType  String   // e.g. "Project", "Inspection"
  entityId    String   // The ID of the thing being changed
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  details     Json?    // Store what changed: { "oldStatus": "PENDING", "newStatus": "APPROVED" }

  @@index([organizationId])
  @@index([entityId])
}

model EmailVerificationToken {
  id String @id @default(cuid())
  createdAt DateTime @default(now())
  code String
  expiresAt DateTime
  email String
  userId String
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  tokenHash String @id
  expiresAt DateTime
  userId String
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Session {
  id String @id
  expiresAt DateTime
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])

}
        


model Comment{
  id String @id @default(cuid())
  createdAt DateTime @default(now())
  content String @db.VarChar(1024)
  
  userId String?
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)


  inspectionId String?
  inspection Inspection? @relation(fields: [inspectionId], references: [id], onDelete: Cascade)


  supplements Supplement[]

  @@index([inspectionId])
  @@index([userId])

}


model Project {
  id              String          @id @default(cuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?
  name            String
  address         String?
  metadata        Json?        // { "facade_type": "glass", "height_m": 120 }
  description     String?
  
  status          ProjectStatus   @default(ACTIVE) // <-- new field

  creatorId String?
  user User? @relation(fields: [creatorId], references: [id], onDelete:SetNull)

  // relationships
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  String

  inspections    Inspection[]

  @@index([creatorId])
  @@index([organizationId])

}


// An Inspection is a single inspection event for a Project on a specific date.
model Inspection {
  id                String           @id @default(cuid())
  title             String
  inspectionDate    DateTime
  status            InspectionStatus @default(SCHEDULED)
  weatherConditions Json?            // { "temp_c": 25, "wind_kph": 10 }
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Foreign Keys
  projectId         String
  conductedByUserId String ?

  // Relations
  project           Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  conductedByUser   User ?        @relation("ConductedByUser", fields: [conductedByUserId], references: [id], onDelete:SetNull)
  job               Job[]         // The background job for this inspection
  analysis          Analysis[]   // The analysis resulting from this inspection
  supplements       Supplement[] // Raw data like drone images
  comments          Comment[]

  referencedInspections Inspection[] @relation("InspectionReferences")
  referencingInspections Inspection[] @relation("InspectionReferences")

  @@index([projectId])
  @@index([conductedByUserId])
}




model Job {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  startedAt   DateTime?     
  completedAt DateTime?     
  type        AnalysisType
  status      JobStatus     @default(PENDING)
  logs        String?       @db.Text
  
  errorMessage String?      @db.Text //  Separate system logs from error output
  
  attemptCount Int          @default(0) //  Helps you retry failed jobs automatically

  // Foreign Keys
  inspectionId String       // Each inspection kicks off one primary job
  
  // Relations
  inspection   Inspection   @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  analysis     Analysis?

  @@index([inspectionId])
 
}


// An Analysis is the computational result derived from an Inspection's data.

model Analysis {
  id          String         @id @default(cuid())
  createdAt   DateTime       @default(now())
  summary     Json?        // { "total_detections": 150, "critical_issues": 12 }


  job     Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId   String @unique

  inspection   Inspection   @relation(fields: [inspectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  inspectionId     String 
  detections       Detection[]
  supplements      Supplement[] // Output files like reports or 3D models

  @@index([inspectionId])
  @@index([jobId])
}


// A Detection is a single, structured finding from an Analysis (e.g., a specific crack).
model Detection {
  id                String            @id @default(cuid())
  createdAt         DateTime          @default(now())
  type              DetectionType?
  severity          DetectionSeverity?
  status            DetectionStatus?   @default(NEW)
  confidenceScore   Float?
  notes             String?           @db.Text
  locationOn3dModel Json?             // { "x": 12.3, "y": 45.6, "z": 78.9 }

  // Foreign Keys
  analysisId        String

  // Relations
  analysis          Analysis          @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  images            DetectionOnImage[] // Many-to-many link to images

  @@index([analysisId])
}


// Junction table for the many-to-many relationship between Detections and Images (Supplements).
model DetectionOnImage {
  // Foreign Keys
  detectionId  String
  supplementId String
  supplementPath String

  // Data specific to this relationship
  boundingBox  Json?
  // STRICT FORMAT: [x, y, width, height] normalized (0.0 to 1.0)
  // Example: [0.5, 0.5, 0.1, 0.2] = Center of image, 10% width, 20% height

  // Relations
  detection    Detection  @relation(fields: [detectionId], references: [id], onDelete: Cascade)
  supplement   Supplement @relation(fields: [supplementId], references: [id], onDelete: Cascade)

  @@id([detectionId, supplementId])
}



model Supplement {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now())
  name String
  //type        SupplementType
  entity      SupplementEntity
  url         String?     // S3 URL key path

  sizeMB    Float?
  format    String?   // jpg, tif, laz, etc.
  metadata  Json?     // EXIF, GPS, resolution, etc.



  inspection   Inspection? @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  inspectionId String?

  analysis     Analysis?    @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  analysisId   String?

  comment   Comment?    @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?
  detections   DetectionOnImage[]

  @@index([inspectionId])
  @@index([analysisId])
  @@index([commentId])

}

 enum SupplementType {
   DRONE_IMAGE
   ORTHOMOSAIC
   POINT_CLOUD
   THREE_D_MODEL
   INSPECTION_REPORT
   THERMAL_MAP
 }

enum SupplementEntity {
  INSPECTION
  ANALYSIS
  COMMENT
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum AnalysisType {
  THREE_D_MODELING
  CRACK_DETECTION
  THERMAL_ANALYSIS
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  DATA_UPLOADING
  COMPLETED
  FAILED
}

enum AnalysisStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum DetectionType {
  SPALLING_CRACK
  EFFLORESCENCE
  WATER_DAMAGE
  CORROSION_STAIN
  INSULATION_FAULT
}

enum DetectionSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DetectionStatus {
  NEW
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
}