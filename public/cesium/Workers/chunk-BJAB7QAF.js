import{a as e}from"./chunk-VHZAK4GN.js";import{d as t}from"./chunk-XQIJGAVD.js";import{b as i,i as o}from"./chunk-UTYWXSQT.js";import{a as r}from"./chunk-RCHWDG3R.js";import{a as n,b as a,c as s,d as c}from"./chunk-KWAHJ72S.js";import{a as l}from"./chunk-MKDADUG3.js";import{a as u,b as m}from"./chunk-NOIUI5SY.js";import{e as f}from"./chunk-XRRBRTKL.js";function d(e,t){m.typeOf.object("ellipsoid",e),this._ellipsoid=e,this._cameraPosition=new n,this._cameraPositionInScaledSpace=new n,this._distanceToLimbInScaledSpaceSquared=0,f(t)&&(this.cameraPosition=t)}Object.defineProperties(d.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){let t=this._ellipsoid.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),i=n.magnitudeSquared(t)-1;n.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=t,this._distanceToLimbInScaledSpaceSquared=i}}});var h=new n;d.prototype.isPointVisible=function(e){return O(this._ellipsoid.transformPositionToScaledSpace(e,h),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},d.prototype.isScaledSpacePointVisible=function(e){return O(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};var p=new n;d.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){let i=this._ellipsoid,o,r;return f(t)&&t<0&&i.minimumRadius>-t?((r=p).x=this._cameraPosition.x/(i.radii.x+t),r.y=this._cameraPosition.y/(i.radii.y+t),r.z=this._cameraPosition.z/(i.radii.z+t),o=r.x*r.x+r.y*r.y+r.z*r.z-1):(r=this._cameraPositionInScaledSpace,o=this._distanceToLimbInScaledSpaceSquared),O(e,r,o)},d.prototype.computeHorizonCullingPoint=function(e,t,i){return g(this._ellipsoid,e,t,i)};var y=c.clone(c.UNIT_SPHERE);d.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,o){return g(b(this._ellipsoid,i,y),e,t,o)},d.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,o,r){return T(this._ellipsoid,e,t,i,o,r)},d.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,o,r,n){return T(b(this._ellipsoid,r,y),e,t,i,o,n)};var S=[];d.prototype.computeHorizonCullingPointFromRectangle=function(e,i,r){m.typeOf.object("rectangle",e);let a=o.subsample(e,i,0,S),s=t.fromPoints(a);if(!(n.magnitude(s.center)<.1*i.minimumRadius))return this.computeHorizonCullingPoint(s.center,a,r)};var x=new n;function b(e,t,i){if(f(t)&&t<0&&e.minimumRadius>-t){let o=n.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,x);e=c.fromCartesian3(o,i)}return e}function g(e,t,i,o){m.typeOf.object("directionToPoint",t),m.defined("positions",i),f(o)||(o=new n);let r=E(e,t),a=0;for(let t=0,o=i.length;t<o;++t){let o=_(e,i[t],r);if(o<0)return;a=Math.max(a,o)}return H(r,a,o)}var N=new n;function T(e,t,i,o,r,a){m.typeOf.object("directionToPoint",t),m.defined("vertices",i),m.typeOf.number("stride",o),f(a)||(a=new n),o=o??3,r=r??n.ZERO;let s=E(e,t),c=0;for(let t=0,n=i.length;t<n;t+=o){N.x=i[t]+r.x,N.y=i[t+1]+r.y,N.z=i[t+2]+r.z;let o=_(e,N,s);if(o<0)return;c=Math.max(c,o)}return H(s,c,a)}function O(e,t,i){let o=n.subtract(e,t,h),r=-n.dot(o,t);return!(i<0?r>0:r>i&&r*r/n.magnitudeSquared(o)>i)}var P=new n,z=new n;function _(e,t,i){let o=e.transformPositionToScaledSpace(t,P),r=n.magnitudeSquared(o),a=Math.sqrt(r),s=n.divideByScalar(o,a,z);r=Math.max(1,r),a=Math.max(1,a);let c=n.dot(s,i),l=n.magnitude(n.cross(s,i,s)),u=1/a,m=Math.sqrt(r-1)*u;return 1/(c*u-l*m)}function H(e,t,i){if(!(t<=0||t===1/0||t!=t))return n.multiplyByScalar(e,t,i)}var j=new n;function E(e,t){return n.equals(t,n.ZERO)?t:(e.transformPositionToScaledSpace(t,j),n.normalize(j,j))}var w=d,I={};I.getHeight=function(e,t,i){if(!Number.isFinite(t))throw new u("scale must be a finite number.");if(!Number.isFinite(i))throw new u("relativeHeight must be a finite number.");return(e-i)*t+i};var v=new a;I.getPosition=function(e,t,i,o,r){let a=t.cartesianToCartographic(e,v);if(!f(a))return n.clone(e,r);let s=I.getHeight(a.height,i,o);return n.fromRadians(a.longitude,a.latitude,s,t,r)};var G=Object.freeze({NONE:0,BITS12:1}),B=new n,q=new n,C=new s,M=new i,V=new i;function A(e,t,o,r,a,s,c,l,u,m){let d=G.NONE,h,p;if(f(t)&&f(o)&&f(r)&&f(a)){let s=t.minimum,c=t.maximum,l=n.subtract(c,s,q),u=r-o;d=4095>Math.max(n.maximumComponent(l),u)?G.BITS12:G.NONE;let m=i.fromScale(l,M);m=i.setTranslation(m,s,m);let f=i.fromScale(n.fromElements(1/l.x,1/l.y,1/l.z,B),V);f=i.multiplyByTranslation(f,n.negate(s,B),f),p=i.clone(a,new i);let y=i.getTranslation(a,B);y=n.subtract(y,e,B),p=i.setTranslation(p,y,p),p=i.multiply(p,m,p),h=i.inverseTransformation(a,new i),h=i.multiply(f,h,h),a=i.multiply(a,m,new i)}this.quantization=d,this.minimumHeight=o,this.maximumHeight=r,this.center=n.clone(e),this.toScaledENU=h,this.fromScaledENU=a,this.matrix=p,this.hasVertexNormals=s??!1,this.hasWebMercatorT=c??!1,this.hasGeodeticSurfaceNormals=l??!1,this.exaggeration=u??1,this.exaggerationRelativeHeight=m??0,this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}A.prototype.encode=function(t,o,r,n,a,c,u,f){m.typeOf.object("vertexBuffer",t),m.typeOf.number("bufferIndex",o),m.typeOf.object("position",r),m.typeOf.object("uv",n),m.typeOf.number("height",a);let d=n.x,h=n.y;if(this.quantization===G.BITS12){(r=i.multiplyByPoint(this.toScaledENU,r,B)).x=l.clamp(r.x,0,1),r.y=l.clamp(r.y,0,1),r.z=l.clamp(r.z,0,1);let n=this.maximumHeight-this.minimumHeight,c=l.clamp((a-this.minimumHeight)/n,0,1);s.fromElements(r.x,r.y,C);let m=e.compressTextureCoordinates(C);s.fromElements(r.z,c,C);let f=e.compressTextureCoordinates(C);s.fromElements(d,h,C);let p=e.compressTextureCoordinates(C);if(t[o++]=m,t[o++]=f,t[o++]=p,this.hasWebMercatorT){s.fromElements(u,0,C);let i=e.compressTextureCoordinates(C);t[o++]=i}}else t[o++]=r.x-this.center.x,t[o++]=r.y-this.center.y,t[o++]=r.z-this.center.z,t[o++]=a,t[o++]=d,t[o++]=h,this.hasWebMercatorT&&(t[o++]=u);return this.hasVertexNormals&&(t[o++]=e.octPackFloat(c)),this.hasGeodeticSurfaceNormals&&(t[o++]=f.x,t[o++]=f.y,t[o++]=f.z),o};var R=new n,U=new n;A.prototype.addGeodeticSurfaceNormals=function(e,t,i){if(m.typeOf.object("oldBuffer",e),m.typeOf.object("newBuffer",t),m.typeOf.object("ellipsoid",i),this.hasGeodeticSurfaceNormals)return;let o=this.stride,r=e.length/o;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();let n=this.stride;for(let a=0;a<r;a++){for(let i=0;i<o;i++){let r=a*o+i;t[a*n+i]=e[r]}let r=this.decodePosition(t,a,R),s=i.geodeticSurfaceNormal(r,U),c=a*n+this._offsetGeodeticSurfaceNormal;t[c]=s.x,t[c+1]=s.y,t[c+2]=s.z}},A.prototype.removeGeodeticSurfaceNormals=function(e,t){if(m.typeOf.object("oldBuffer",e),m.typeOf.object("newBuffer",t),!this.hasGeodeticSurfaceNormals)return;let i=this.stride,o=e.length/i;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();let r=this.stride;for(let n=0;n<o;n++)for(let o=0;o<r;o++){let a=n*i+o;t[n*r+o]=e[a]}},A.prototype.decodePosition=function(t,o,r){if(m.typeOf.object("buffer",t),m.typeOf.number("index",o),f(r)||(r=new n),o*=this.stride,this.quantization===G.BITS12){let n=e.decompressTextureCoordinates(t[o],C);r.x=n.x,r.y=n.y;let a=e.decompressTextureCoordinates(t[o+1],C);return r.z=a.x,i.multiplyByPoint(this.fromScaledENU,r,r)}return r.x=t[o],r.y=t[o+1],r.z=t[o+2],n.add(r,this.center,r)},A.prototype.getExaggeratedPosition=function(e,t,i){i=this.decodePosition(e,t,i);let o=this.exaggeration,r=this.exaggerationRelativeHeight;if(1!==o&&this.hasGeodeticSurfaceNormals){let n=this.decodeGeodeticSurfaceNormal(e,t,U),a=this.decodeHeight(e,t),s=I.getHeight(a,o,r)-a;i.x+=n.x*s,i.y+=n.y*s,i.z+=n.z*s}return i},A.prototype.decodeTextureCoordinates=function(t,i,o){return m.typeOf.object("buffer",t),m.typeOf.number("index",i),f(o)||(o=new s),i*=this.stride,this.quantization===G.BITS12?e.decompressTextureCoordinates(t[i+2],o):s.fromElements(t[i+4],t[i+5],o)},A.prototype.decodeHeight=function(t,i){return m.typeOf.object("buffer",t),m.typeOf.number("index",i),i*=this.stride,this.quantization===G.BITS12?e.decompressTextureCoordinates(t[i+1],C).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:t[i+3]},A.prototype.decodeWebMercatorT=function(t,i){return m.typeOf.object("buffer",t),m.typeOf.number("index",i),i*=this.stride,this.quantization===G.BITS12?e.decompressTextureCoordinates(t[i+3],C).x:t[i+6]},A.prototype.getOctEncodedNormal=function(e,t,i){m.typeOf.object("buffer",e),m.typeOf.number("index",t);let o=e[t=t*this.stride+this._offsetVertexNormal]/256,r=Math.floor(o);return s.fromElements(r,(o-r)*256,i)},A.prototype.decodeNormal=function(t,i,o){m.typeOf.object("buffer",t),m.typeOf.number("index",i),m.typeOf.object("result",o);let r=i=i*this.stride+this._offsetVertexNormal;return e.octDecodeFloat(t[r],o)},A.prototype.decodeGeodeticSurfaceNormal=function(e,t,i){return m.typeOf.object("buffer",e),m.typeOf.number("index",t),m.typeOf.object("result",i),i.x=e[t=t*this.stride+this._offsetGeodeticSurfaceNormal],i.y=e[t+1],i.z=e[t+2],i},A.prototype._calculateStrideAndOffsets=function(){let e=0;this.quantization===G.BITS12?e+=3:e+=6,this.hasWebMercatorT&&(e+=1),this.hasVertexNormals&&(this._offsetVertexNormal=e,e+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=e,e+=3),this.stride=e};var W={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},k={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};A.prototype.getAttributes=function(e){m.typeOf.object("buffer",e);let t=r.FLOAT,i=r.getSizeInBytes(t),o=this.stride*i,n=0,a=[];function s(r,s){a.push({index:r,vertexBuffer:e,componentDatatype:t,componentsPerAttribute:s,offsetInBytes:n,strideInBytes:o}),n+=s*i}if(this.quantization===G.NONE){let e;s(W.position3DAndHeight,4),e=2+(+!!this.hasWebMercatorT+ +!!this.hasVertexNormals),s(W.textureCoordAndEncodedNormals,e),this.hasGeodeticSurfaceNormals&&s(W.geodeticSurfaceNormal,3)}else{let e=this.hasWebMercatorT||this.hasVertexNormals,t=this.hasWebMercatorT&&this.hasVertexNormals;s(k.compressed0,e?4:3),t&&s(k.compressed1,1),this.hasGeodeticSurfaceNormals&&s(k.geodeticSurfaceNormal,3)}return a},A.prototype.getAttributeLocations=function(){return this.quantization===G.NONE?W:k},A.clone=function(e,t){if(f(e))return f(t)||(t=new A),t.quantization=e.quantization,t.minimumHeight=e.minimumHeight,t.maximumHeight=e.maximumHeight,t.center=n.clone(e.center),t.toScaledENU=i.clone(e.toScaledENU),t.fromScaledENU=i.clone(e.fromScaledENU),t.matrix=i.clone(e.matrix),t.hasVertexNormals=e.hasVertexNormals,t.hasWebMercatorT=e.hasWebMercatorT,t.hasGeodeticSurfaceNormals=e.hasGeodeticSurfaceNormals,t.exaggeration=e.exaggeration,t.exaggerationRelativeHeight=e.exaggerationRelativeHeight,t._calculateStrideAndOffsets(),t};var D=A;export{w as a,D as b};