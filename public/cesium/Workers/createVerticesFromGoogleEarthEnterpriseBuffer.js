import{a as t,b as e}from"./chunk-BJAB7QAF.js";import{a as i}from"./chunk-D2NFCOGE.js";import{a as n}from"./chunk-XBWRWNYZ.js";import{a as o}from"./chunk-SCO7TMKT.js";import"./chunk-VHZAK4GN.js";import"./chunk-ET7KY3BS.js";import{a as r}from"./chunk-CUP6SILZ.js";import"./chunk-HSJ6GSLC.js";import"./chunk-SXKYZMEL.js";import{d as a}from"./chunk-XQIJGAVD.js";import{b as s,h as l,i as u}from"./chunk-UTYWXSQT.js";import"./chunk-RCHWDG3R.js";import"./chunk-4WJUWBRK.js";import{a as h}from"./chunk-5G23AKP3.js";import{a as c,b as d,c as g,d as m}from"./chunk-KWAHJ72S.js";import{a as p}from"./chunk-MKDADUG3.js";import"./chunk-NOIUI5SY.js";import{e as f}from"./chunk-XRRBRTKL.js";var E=Uint16Array.BYTES_PER_ELEMENT,T=Int32Array.BYTES_PER_ELEMENT,S=Uint32Array.BYTES_PER_ELEMENT,x=Float32Array.BYTES_PER_ELEMENT,R=Float64Array.BYTES_PER_ELEMENT;function I(t,e,i){i=i??p;let n=t.length;for(let o=0;o<n;++o)if(i.equalsEpsilon(t[o],e,p.EPSILON12))return o;return -1}var k=new d,B=new c,A=new c,y=new c,w=new s;function M(t,e,i,n,o,r,a,l,u,h,m){let E=l.length;for(let T=0;T<E;++T){let S=l[T],x=S.cartographic,R=S.index,I=t.length,A=x.longitude,y=x.latitude;y=p.clamp(y,-p.PI_OVER_TWO,p.PI_OVER_TWO);let w=x.height-a.skirtHeight;a.hMin=Math.min(a.hMin,w),d.fromRadians(A,y,w,k),h&&(k.longitude+=u),h?T===E-1?k.latitude+=m:0===T&&(k.latitude-=m):k.latitude+=u;let M=a.ellipsoid.cartographicToCartesian(k);t.push(M),e.push(w),i.push(g.clone(i[R])),n.length>0&&n.push(n[R]),o.length>0&&o.push(o[R]),s.multiplyByPoint(a.toENU,M,B);let v=a.minimum,W=a.maximum;c.minimumByComponent(B,v,v),c.maximumByComponent(B,W,W);let P=a.lastBorderPoint;if(f(P)){let t=P.index;r.push(t,I-1,I,I,R,t)}a.lastBorderPoint=S}}var v=i(function(i,v){i.ellipsoid=m.clone(i.ellipsoid),i.rectangle=u.clone(i.rectangle);let W=function(i,u,m,v,W,P,N,b,C,j,U){let H,F,_,L,Y,D;f(v)?(H=v.west,F=v.south,_=v.east,L=v.north,Y=v.width,D=v.height):(H=p.toRadians(W.west),F=p.toRadians(W.south),_=p.toRadians(W.east),L=p.toRadians(W.north),Y=p.toRadians(v.width),D=p.toRadians(v.height));let K=[F,L],O=[H,_],G=l.eastNorthUpToFixedFrame(u,m),J=s.inverseTransformation(G,w),V,X;C&&(V=n.geodeticLatitudeToMercatorAngle(F),X=1/(n.geodeticLatitudeToMercatorAngle(L)-V));let Z=1!==P,z=new DataView(i),Q=1/0,q=-1/0;A.x=1/0,A.y=1/0,A.z=1/0,y.x=-1/0,y.y=-1/0,y.z=-1/0;let $=0,tt=0,te=0,ti,tn;for(tn=0;tn<4;++tn){let t=$;ti=z.getUint32(t,!0),t+=S;let e=p.toRadians(180*z.getFloat64(t,!0));t+=R,-1===I(O,e)&&O.push(e);let i=p.toRadians(180*z.getFloat64(t,!0));t+=R,-1===I(K,i)&&K.push(i),t+=2*R;let n=z.getInt32(t,!0);t+=T,tt+=n,te+=3*(n=z.getInt32(t,!0)),$+=ti+S}let to=[],tr=[],ta=Array(tt),ts=Array(tt),tl=Array(tt),tu=C?Array(tt):[],th=Z?Array(tt):[],tc=Array(te),td=[],tg=[],tm=[],tp=[],tf=0,tE=0;for($=0,tn=0;tn<4;++tn){ti=z.getUint32($,!0);let t=$+=S,e=p.toRadians(180*z.getFloat64($,!0));$+=R;let i=p.toRadians(180*z.getFloat64($,!0));$+=R;let o=p.toRadians(180*z.getFloat64($,!0)),r=.5*o;$+=R;let a=p.toRadians(180*z.getFloat64($,!0)),l=.5*a;$+=R;let u=z.getInt32($,!0);$+=T;let f=z.getInt32($,!0);$+=T,$+=T;let w=Array(u);for(let t=0;t<u;++t){let u=e+z.getUint8($++)*o;k.longitude=u;let h=i+z.getUint8($++)*a;k.latitude=h;let f=z.getFloat32($,!0);if($+=x,0!==f&&f<U&&(f*=-Math.pow(2,j)),k.height=f*=6371010,-1!==I(O,u)||-1!==I(K,h)){let e=I(to,k,d);if(-1===e)to.push(d.clone(k)),tr.push(tf);else{w[t]=tr[e];continue}}w[t]=tf,Math.abs(u-H)<r?td.push({index:tf,cartographic:d.clone(k)}):Math.abs(u-_)<r?tm.push({index:tf,cartographic:d.clone(k)}):Math.abs(h-F)<l?tg.push({index:tf,cartographic:d.clone(k)}):Math.abs(h-L)<l&&tp.push({index:tf,cartographic:d.clone(k)}),Q=Math.min(f,Q),q=Math.max(f,q),tl[tf]=f;let E=m.cartographicToCartesian(k);if(ta[tf]=E,C&&(tu[tf]=(n.geodeticLatitudeToMercatorAngle(h)-V)*X),Z){let t=m.geodeticSurfaceNormal(E);th[tf]=t}s.multiplyByPoint(J,E,B),c.minimumByComponent(B,A,A),c.maximumByComponent(B,y,y);let T=(u-H)/(_-H);T=p.clamp(T,0,1);let S=(h-F)/(L-F);S=p.clamp(S,0,1),ts[tf]=new g(T,S),++tf}let M=3*f;for(let t=0;t<M;++t,++tE)tc[tE]=w[z.getUint16($,!0)],$+=E;if(ti!==$-t)throw new h("Invalid terrain tile.")}ta.length=tf,ts.length=tf,tl.length=tf,C&&(tu.length=tf),Z&&(th.length=tf);let tT=tf,tS=tE,tx={hMin:Q,lastBorderPoint:void 0,skirtHeight:b,toENU:J,ellipsoid:m,minimum:A,maximum:y};if(td.sort(function(t,e){return e.cartographic.latitude-t.cartographic.latitude}),tg.sort(function(t,e){return t.cartographic.longitude-e.cartographic.longitude}),tm.sort(function(t,e){return t.cartographic.latitude-e.cartographic.latitude}),tp.sort(function(t,e){return e.cartographic.longitude-t.cartographic.longitude}),M(ta,tl,ts,tu,th,tc,tx,td,-1e-5*Y,!0,-1e-5*D),M(ta,tl,ts,tu,th,tc,tx,tg,-1e-5*D,!1),M(ta,tl,ts,tu,th,tc,tx,tm,1e-5*Y,!0,1e-5*D),M(ta,tl,ts,tu,th,tc,tx,tp,1e-5*D,!1),td.length>0&&tp.length>0){let t=td[0].index,e=tp[tp.length-1].index,i=ta.length-1;tc.push(e,i,tT,tT,t,e)}tt=ta.length;let tR=a.fromPoints(ta),tI;f(v)&&(tI=o.fromRectangle(v,Q,q,m));let tk=new t(m).computeHorizonCullingPointPossiblyUnderEllipsoid(u,ta,Q),tB=new r(A,y,u),tA=new e(u,tB,tx.hMin,q,G,!1,C,Z,P,N),ty=new Float32Array(tt*tA.stride),tw=0;for(let t=0;t<tt;++t)tw=tA.encode(ty,tw,ta[t],ts[t],tl[t],void 0,tu[t],th[t]);let tM=td.map(function(t){return t.index}).reverse(),tv=tg.map(function(t){return t.index}).reverse(),tW=tm.map(function(t){return t.index}).reverse(),tP=tp.map(function(t){return t.index}).reverse();return tv.unshift(tW[tW.length-1]),tv.push(tM[0]),tP.unshift(tM[tM.length-1]),tP.push(tW[0]),{vertices:ty,indices:new Uint16Array(tc),maximumHeight:q,minimumHeight:Q,encoding:tA,boundingSphere3D:tR,orientedBoundingBox:tI,occludeePointInScaledSpace:tk,vertexCountWithoutSkirts:tT,indexCountWithoutSkirts:tS,westIndicesSouthToNorth:tM,southIndicesEastToWest:tv,eastIndicesNorthToSouth:tW,northIndicesWestToEast:tP}}(i.buffer,i.relativeToCenter,i.ellipsoid,i.rectangle,i.nativeRectangle,i.exaggeration,i.exaggerationRelativeHeight,i.skirtHeight,i.includeWebMercatorT,i.negativeAltitudeExponentBias,i.negativeElevationThreshold),P=W.vertices;v.push(P.buffer);let N=W.indices;return v.push(N.buffer),{vertices:P.buffer,indices:N.buffer,numberOfAttributes:W.encoding.stride,minimumHeight:W.minimumHeight,maximumHeight:W.maximumHeight,boundingSphere3D:W.boundingSphere3D,orientedBoundingBox:W.orientedBoundingBox,occludeePointInScaledSpace:W.occludeePointInScaledSpace,encoding:W.encoding,vertexCountWithoutSkirts:W.vertexCountWithoutSkirts,indexCountWithoutSkirts:W.indexCountWithoutSkirts,westIndicesSouthToNorth:W.westIndicesSouthToNorth,southIndicesEastToWest:W.southIndicesEastToWest,eastIndicesNorthToSouth:W.eastIndicesNorthToSouth,northIndicesWestToEast:W.northIndicesWestToEast}});export{v as default};