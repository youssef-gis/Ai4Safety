import{a as e}from"./chunk-D2NFCOGE.js";import{a as t}from"./chunk-VHZAK4GN.js";import{a as r}from"./chunk-T6Q6HX5J.js";import{d as s,i as a}from"./chunk-UTYWXSQT.js";import"./chunk-RCHWDG3R.js";import"./chunk-4WJUWBRK.js";import"./chunk-5G23AKP3.js";import{a as n,b as i,d as o}from"./chunk-KWAHJ72S.js";import{a as l}from"./chunk-MKDADUG3.js";import"./chunk-NOIUI5SY.js";import"./chunk-XRRBRTKL.js";var d=Math.cos(l.toRadians(150)),f=new i,h=new n,u=new i,c=new i;function p(e){let t=8*e,s=3*t,a=4*t;this.startEllipsoidNormals=new Float32Array(s),this.endEllipsoidNormals=new Float32Array(s),this.startPositionAndHeights=new Float32Array(a),this.startFaceNormalAndVertexCornerIds=new Float32Array(a),this.endPositionAndHeights=new Float32Array(a),this.endFaceNormalAndHalfWidths=new Float32Array(a),this.vertexBatchIds=new Uint16Array(t),this.indices=r.createTypedArray(t,36*e),this.vec3Offset=0,this.vec4Offset=0,this.batchIdOffset=0,this.indexOffset=0,this.volumeStartIndex=0}var m=new n,A=new n;function w(e,t,r,s,a){let i=n.subtract(r,t,A),o=n.subtract(t,e,m);return n.normalize(i,i),n.normalize(o,o),n.dot(i,o)<d&&(o=n.multiplyByScalar(o,-1,m)),n.add(i,o,a),n.equals(a,n.ZERO)&&(a=n.subtract(e,t)),n.cross(a,s,a),n.cross(s,a,a),n.normalize(a,a),a}var b=[0,2,6,0,6,4,0,1,3,0,3,2,0,4,5,0,5,1,5,3,1,5,7,3,7,5,4,7,4,6,7,6,2,7,2,3],k=b.length,N=new n,g=new n,y=new n,I=new n,F=new n;p.prototype.addVolume=function(e,t,r,s,a,i,o,l,d,f){let h=n.add(t,d,N),u=f.geodeticSurfaceNormal(h,g);h=n.add(r,d,N);let c=f.geodeticSurfaceNormal(h,I),p=w(e,t,r,u,y),m=w(s,r,t,c,F),A=this.startEllipsoidNormals,H=this.endEllipsoidNormals,x=this.startPositionAndHeights,E=this.startFaceNormalAndVertexCornerIds,v=this.endPositionAndHeights,O=this.endFaceNormalAndHalfWidths,P=this.vertexBatchIds,S=this.batchIdOffset,U=this.vec3Offset,j=this.vec4Offset,R;for(R=0;R<8;R++)n.pack(u,A,U),n.pack(c,H,U),n.pack(t,x,j),x[j+3]=a,n.pack(r,v,j),v[j+3]=i,n.pack(p,E,j),E[j+3]=R,n.pack(m,O,j),O[j+3]=o,P[S++]=l,U+=3,j+=4;this.batchIdOffset=S,this.vec3Offset=U,this.vec4Offset=j;let B=this.indices,D=this.volumeStartIndex,T=this.indexOffset;for(R=0;R<k;R++)B[T+R]=b[R]+D;this.volumeStartIndex+=8,this.indexOffset+=k};var H=new a,x=new o,E=new n,v=new n,O=new n,P=new n,S=new n,U=e(function(e,d){let m=new Uint16Array(e.positions),A=new Uint16Array(e.widths),w=new Uint32Array(e.counts),b=new Uint16Array(e.batchIds),k=new Float64Array(e.packedBuffer),N=0,g=k[N++],y=k[N++];a.unpack(k,N,H),N+=a.packedLength,o.unpack(k,N,x),N+=o.packedLength,n.unpack(k,N,E);let I,F=m.length/3,U=m.subarray(0,F),j=m.subarray(F,2*F),R=m.subarray(2*F,3*F);t.zigZagDeltaDecode(U,j,R),function(e,t,r,s){let a=s.length,n=e.length,o=new Uint8Array(n),l=0;for(let r=0;r<a;r++){let a=s[r],n=a;for(let r=1;r<a;r++){let s=l+r,a=s-1;c.longitude=e[s],c.latitude=t[s],u.longitude=e[a],u.latitude=t[a],i.equals(c,u)&&(n--,o[a]=1)}s[r]=n,l+=a}let d=0;for(let s=0;s<n;s++)1!==o[s]&&(e[d]=e[s],t[d]=t[s],r[d]=r[s],d++)}(U,j,R,w);let B=w.length,D=0;for(I=0;I<B;I++)D+=w[I]-1;let T=new p(D),W=function(e,t,r,s,a,o,d){let u=e.length,c=new Float64Array(3*u);for(let p=0;p<u;++p){let u=e[p],m=t[p],A=r[p],w=l.lerp(s.west,s.east,u/32767),b=l.lerp(s.south,s.north,m/32767),k=l.lerp(a,o,A/32767),N=i.fromRadians(w,b,k,f),g=d.cartographicToCartesian(N,h);n.pack(g,c,3*p)}return c}(U,j,R,H,g,y,x,E),V=new Float32Array(3*(F=U.length));for(I=0;I<F;++I)V[3*I]=W[3*I]-E.x,V[3*I+1]=W[3*I+1]-E.y,V[3*I+2]=W[3*I+2]-E.z;let C=0,G=0;for(I=0;I<B;I++){let e=w[I]-1,t=.5*A[I],r=b[I],s=C;for(let a=0;a<e;a++){let i=n.unpack(V,C,O),o=n.unpack(V,C+3,P),d=R[G],f=R[G+1];d=l.lerp(g,y,d/32767),f=l.lerp(g,y,f/32767),G++;let h=v,u=S;if(0===a){let t=s+3*e,r=n.unpack(V,t,v);if(n.equals(r,i))n.unpack(V,t-3,h);else{let e=n.subtract(i,o,v);h=n.add(e,i,v)}}else n.unpack(V,C-3,h);if(a===e-1){let e=n.unpack(V,s,S);if(n.equals(e,o))n.unpack(V,s+3,u);else{let e=n.subtract(o,i,S);u=n.add(e,o,S)}}else n.unpack(V,C+6,u);T.addVolume(h,i,o,u,d,f,t,r,E,x),C+=3}C+=3,G++}let K=T.indices;d.push(T.startEllipsoidNormals.buffer),d.push(T.endEllipsoidNormals.buffer),d.push(T.startPositionAndHeights.buffer),d.push(T.startFaceNormalAndVertexCornerIds.buffer),d.push(T.endPositionAndHeights.buffer),d.push(T.endFaceNormalAndHalfWidths.buffer),d.push(T.vertexBatchIds.buffer),d.push(K.buffer);let z={indexDatatype:2===K.BYTES_PER_ELEMENT?r.UNSIGNED_SHORT:r.UNSIGNED_INT,startEllipsoidNormals:T.startEllipsoidNormals.buffer,endEllipsoidNormals:T.endEllipsoidNormals.buffer,startPositionAndHeights:T.startPositionAndHeights.buffer,startFaceNormalAndVertexCornerIds:T.startFaceNormalAndVertexCornerIds.buffer,endPositionAndHeights:T.endPositionAndHeights.buffer,endFaceNormalAndHalfWidths:T.endFaceNormalAndHalfWidths.buffer,vertexBatchIds:T.vertexBatchIds.buffer,indices:K.buffer};if(e.keepDecodedPositions){let e=function(e){let t=e.length,r=new Uint32Array(t+1),s=0;for(let a=0;a<t;++a)r[a]=s,s+=e[a];return r[t]=s,r}(w);d.push(W.buffer,e.buffer),z=s(z,{decodedPositions:W.buffer,decodedPositionOffsets:e.buffer})}return z});export{U as default};